name: "ğŸš€ Cross-Platform Release Build"

on:
  push:
    tags:
      - "v*.*.*"
      - "v*.*"
  workflow_dispatch:

jobs:
  # ----------------------------------------------------
  # JOB 1: å¹¶è¡Œæ„å»º (Fan-out)
  # ----------------------------------------------------
  build-assets:
    name: "Build ${{ matrix.asset_suffix }}" 
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        include:
          - target: armv7-unknown-linux-musleabihf
            asset_suffix: wpa_supplicant-dbus-armv7-musleabihf
            features: "provisioner-daemon/backend_wpa_dbus,provisioner-daemon/ui_echo_mate"
            env_rustflags: "-C target-feature=+crt-static"

          - target: armv7-unknown-linux-musleabihf
            asset_suffix: wpa_cli-dnsmasq-armv7-musleabihf
            features: "provisioner-daemon/backend_wpa_cli_exclusive,provisioner-daemon/ui_echo_mate"
            env_rustflags: "-C target-feature=+crt-static"

    steps:
      - name: "1. Checkout Repository"
        uses: actions/checkout@v4

      - name: "2. Install Rust Toolchain"
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: ${{ matrix.target }}

      - name: "3. Install 'cross'"
        run: cargo install cross --git https://github.com/cross-rs/cross --branch main

      - name: "4. Set Target-Specific Rustflags (via Env)"
        if: matrix.env_rustflags
        run: |
          TARGET_ENV_VAR=$(echo "CARGO_TARGET_${{ matrix.target }}" | tr '[:lower:]-' '[:upper:]_')"_RUSTFLAGS"
          echo "Setting $TARGET_ENV_VAR=${{ matrix.env_rustflags }}"
          echo "$TARGET_ENV_VAR=${{ matrix.env_rustflags }}" >> $GITHUB_ENV
          
      - name: "5. Build Static Binary"
        id: build
        env:
          PROGRAM_NAME: "provisioner-daemon"
        run: |
          BUILD_COMMAND="cross build --target=${{ matrix.target }} --release"
          if [ -n "${{ matrix.features }}" ]; then
            BUILD_COMMAND="$BUILD_COMMAND --features \"${{ matrix.features }}\""
          fi

          echo "Running: $BUILD_COMMAND"
          eval $BUILD_COMMAND
          
          SOURCE_PATH="target/${{ matrix.target }}/release/${PROGRAM_NAME}"
          DEST_NAME="${PROGRAM_NAME}-${{ matrix.asset_suffix }}"
          
          echo "Moving '$SOURCE_PATH' to '$DEST_NAME'"
          mv $SOURCE_PATH $DEST_NAME
          
          # å°†ç›®æ ‡æ–‡ä»¶åè¾“å‡ºï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "asset_path=$DEST_NAME" >> $GITHUB_OUTPUT

      # --- ä¿®æ”¹ç‚¹ 1: ä¸ä¸Šä¼ åˆ°Releaseï¼Œè€Œæ˜¯ä¿å­˜ä¸ºArtifact ---
      - name: "6. Upload Artifact"
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.asset_path }} # ä½¿ç”¨å”¯ä¸€åç§°
          path: ${{ steps.build.outputs.asset_path }} # ä¸Šä¼ è¯¥æ–‡ä»¶
          retention-days: 1 # ä»…ä¿ç•™1å¤©

  # ----------------------------------------------------
  # JOB 2: åˆ›å»ºå¹¶å‘å¸ƒ (Fan-in)
  # ----------------------------------------------------
  create-release:
    name: "Create & Publish Release"
    runs-on: ubuntu-latest
    
    # --- ä¿®æ”¹ç‚¹ 2: ä¾èµ– build-assets Job ---
    # ç¡®ä¿æ‰€æœ‰æ„å»ºå®Œæˆåæ‰è¿è¡Œ
    needs: build-assets 
    
    permissions:
      contents: write # åªéœ€è¦è¿™ä¸ªJobæœ‰å†™æƒé™

    steps:

      - name: "1. Checkout Repository"
        uses: actions/checkout@v4

      - name: "2. Create Release"
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
            tag_name: ${{ github.ref_name }}
            release_name: Release ${{ github.ref_name }}
            draft: false
            prerelease: false

      # --- ä¿®æ”¹ç‚¹ 3: ä¸‹è½½æ‰€æœ‰ Artifacts ---
      - name: "3. Download All Artifacts"
        uses: actions/download-artifact@v4
        with:
          # ä¸æŒ‡å®š nameï¼Œä¼šä¸‹è½½æ‰€æœ‰ Artifacts
          path: artifacts # ä¸‹è½½åˆ° 'artifacts' æ–‡ä»¶å¤¹

      # --- ä¿®æ”¹ç‚¹ 4: å¾ªç¯ä¸Šä¼ æ‰€æœ‰äº§ç‰© ---
      - name: "4. Upload All Release Assets"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # artifacts ç›®å½•ç»“æ„ä¼šæ˜¯:
          # artifacts/provisioner-daemon-wpa_supplicant-dbus.../provisioner-daemon-wpa_supplicant-dbus...
          # artifacts/provisioner-daemon-wpa_cli-dnsmasq.../provisioner-daemon-wpa_cli-dnsmasq...
          
          # æˆ‘ä»¬éœ€è¦æ‰¾åˆ°æ‰€æœ‰ä¸‹è½½çš„äºŒè¿›åˆ¶æ–‡ä»¶
          # ä½¿ç”¨ find æ‰¾åˆ°æ‰€æœ‰åœ¨ 'artifacts' å­ç›®å½•ä¸­çš„æ–‡ä»¶
          find artifacts -type f | while read asset_path; do
            asset_name=$(basename "$asset_path")
            echo "Uploading $asset_name from $asset_path"
            
            # ä½¿ç”¨ actions/upload-release-asset@v1 æ¨èçš„ gh release upload å‘½ä»¤
            gh release upload \
              "${{ github.ref_name }}" \
              "$asset_path" \
              --clobber # å¦‚æœåŒåæ–‡ä»¶å­˜åœ¨åˆ™è¦†ç›–
          done