name: "ğŸš€ Cross-Platform Release Build"

on:
  push:
    tags:
      - "v*.*.*"
      - "v*.*"
  workflow_dispatch:

jobs:
  # ----------------------------------------------------
  # JOB 1: å¹¶è¡Œæ„å»º (Fan-out)
  # ----------------------------------------------------
  build-assets:
    name: "Build ${{ matrix.asset_suffix }}" 
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        include:
          - target: armv7-unknown-linux-musleabihf
            asset_suffix: echo-mate-armv7-musleabihf
            env_rustflags: "-C target-feature=+crt-static"

          # - target: armv7-unknown-linux-musleabihf
          #   asset_suffix: wpa_cli-dnsmasq-armv7-musleabihf
          #   features: "provisioner-daemon/backend_wpa_cli_exclusive,provisioner-daemon/ui_echo_mate"
          #   env_rustflags: "-C target-feature=+crt-static"

    steps:
      - name: "1. Checkout Repository"
        uses: actions/checkout@v4

      - name: "2. Install Rust Toolchain"
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: ${{ matrix.target }}

      - name: "3. Install 'cross'"
        run: cargo install cross --git https://github.com/cross-rs/cross --branch main

      - name: "4. Set Target-Specific Rustflags (via Env)"
        if: matrix.env_rustflags
        run: |
          TARGET_ENV_VAR=$(echo "CARGO_TARGET_${{ matrix.target }}" | tr '[:lower:]-' '[:upper:]_')"_RUSTFLAGS"
          echo "Setting $TARGET_ENV_VAR=${{ matrix.env_rustflags }}"
          echo "$TARGET_ENV_VAR=${{ matrix.env_rustflags }}" >> $GITHUB_ENV
          
      - name: "5. Build Static Binary"
        id: build
        env:
          PROGRAM_NAME: "provisioner"
        run: |
          BUILD_COMMAND="cross build --target=${{ matrix.target }} --release"
          if [ -n "${{ matrix.features }}" ]; then
            BUILD_COMMAND="$BUILD_COMMAND --features \"${{ matrix.features }}\""
          fi

          echo "Running: $BUILD_COMMAND"
          eval $BUILD_COMMAND
          
          SOURCE_PATH="target/${{ matrix.target }}/release/${PROGRAM_NAME}"
          DEST_NAME="${PROGRAM_NAME}-${{ matrix.asset_suffix }}"
          
          echo "Moving '$SOURCE_PATH' to '$DEST_NAME'"
          mv $SOURCE_PATH $DEST_NAME
          
          # å°†ç›®æ ‡æ–‡ä»¶åè¾“å‡ºï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "asset_path=$DEST_NAME" >> $GITHUB_OUTPUT

      # --- ä¸ä¸Šä¼ åˆ°Releaseï¼Œè€Œæ˜¯ä¿å­˜ä¸ºArtifact ---
      - name: "6. Upload Artifact"
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.asset_path }} # ä½¿ç”¨å”¯ä¸€åç§°
          path: ${{ steps.build.outputs.asset_path }} # ä¸Šä¼ è¯¥æ–‡ä»¶
          retention-days: 1 # ä»…ä¿ç•™1å¤©

  # ----------------------------------------------------
  # JOB 2: åˆ›å»ºå¹¶å‘å¸ƒ (Fan-in)
  # ----------------------------------------------------
  create-release:
    name: "Create & Publish Release"
    runs-on: ubuntu-latest
    
    # --- ä¸ä¾èµ– build-assets Job ---
    # ç¡®ä¿æ‰€æœ‰æ„å»ºå®Œæˆåæ‰è¿è¡Œ
    needs: build-assets 
    
    permissions:
      contents: write # åªéœ€è¦è¿™ä¸ªJobæœ‰å†™æƒé™

    steps:

      - name: "1. Checkout Repository"
        uses: actions/checkout@v4

      - name: "2. Create Release"
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
            tag_name: ${{ github.ref_name }}
            release_name: Release ${{ github.ref_name }}
            draft: false
            prerelease: false

      # --- ä¸‹è½½æ‰€æœ‰ Artifacts ---
      - name: "3. Download All Artifacts"
        uses: actions/download-artifact@v4
        with:
          # ä¸æŒ‡å®š nameï¼Œä¼šä¸‹è½½æ‰€æœ‰ Artifacts
          path: artifacts # ä¸‹è½½åˆ° 'artifacts' æ–‡ä»¶å¤¹

      # --- å¾ªç¯ä¸Šä¼ æ‰€æœ‰äº§ç‰© ---
      - name: "4. Package & Upload All Assets"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          UI_ASSET_NAME="ui-assets-${{ github.ref_name }}.tar.gz"
          
          echo "Packaging UI folder into $UI_ASSET_NAME"
          
          # -c: åˆ›å»º (create)
          # -z: Gzip å‹ç¼©
          # -f: æ–‡ä»¶ (file)
          # -C .: åˆ‡æ¢åˆ°å½“å‰ç›®å½• (workspace æ ¹ç›®å½•)
          # ui:   è¦å‹ç¼©çš„æ–‡ä»¶å¤¹
          tar -czf $UI_ASSET_NAME -C . ui
          
          echo "Uploading UI asset: $UI_ASSET_NAME"
          gh release upload \
            "${{ github.ref_name }}" \
            "$UI_ASSET_NAME" \
            --clobber
          
          echo "--- UI asset upload complete ---"
        
          echo "--- Starting binary artifact uploads ---"
          find artifacts -type f | while read asset_path; do
            asset_name=$(basename "$asset_path")
            echo "Uploading binary: $asset_name from $asset_path"
            
            gh release upload \
              "${{ github.ref_name }}" \
              "$asset_path" \
              --clobber
          done