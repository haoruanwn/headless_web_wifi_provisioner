name: "ğŸš€ Cross-Platform Release Build"

on:
  # æ ¸å¿ƒè§¦å‘å™¨ï¼šå½“ä¸€ä¸ª "v" å¼€å¤´çš„æ ‡ç­¾è¢«æ¨é€åˆ°ä»“åº“æ—¶
  # ä¾‹å¦‚: git tag v1.0.2 && git push --tags
  push:
    tags:
      - "v*.*.*"
      - "v*.*" # ä¹Ÿæ”¯æŒ v1.0 è¿™ç§
      
  # è¾…åŠ©è§¦å‘å™¨ï¼šå…è®¸åœ¨ GitHub ç½‘ç«™ä¸Šæ‰‹åŠ¨è¿è¡Œæ­¤æµç¨‹
  workflow_dispatch:

jobs:
  build-and-release:
    name: "Build & Release Assets"
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        include:
          - target: armv7-unknown-linux-musleabihf
            asset_suffix: armv7-musleabihf
            features: "provisioner-daemon/backend_wpa_dbus,provisioner-daemon/ui_bootstrap"
            env_rustflags: "-C target-feature=+crt-static"

        #   - target: x86_64-unknown-linux-musl
        #     asset_suffix: x86_64-musl
        #     features: "" 
        #     env_rustflags: "-C target-feature=+crt-static"
            
          # - target: aarch64-unknown-linux-musl
          #   asset_suffix: aarch64-musl
          #   features: "some-other-features"
          #   env_rustflags: "-C target-feature=+crt-static"

    steps:
      - name: "1. Checkout Repository"
        uses: actions/checkout@v4

      - name: "2. Install Rust Toolchain"
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          # è‡ªåŠ¨ä¸º 'cross' å®‰è£…æ‰€éœ€çš„ç›®æ ‡
          targets: ${{ matrix.target }}

      - name: "3. Install 'cross' for cross-compilation"
        # ä» git main å®‰è£…ï¼Œè·å–æœ€æ–°çš„å®¹å™¨é•œåƒæ”¯æŒ
        run: cargo install cross --git https://github.com/cross-rs/cross --branch main

      - name: "4. Set Target-Specific Rustflags (via Env)"
        if: matrix.env_rustflags
        run: |
          # è¿™æ˜¯æˆ‘ä»¬ä¹‹å‰å•†å®šçš„ "æ— config.tomlæ–‡ä»¶" çš„æ–¹æ¡ˆ
          # å°† 'armv7-unknown-linux-musleabihf' è½¬æ¢ä¸º 'CARGO_TARGET_ARMV7_UNKNOWN_LINUX_MUSLEABIHF_RUSTFLAGS'
          TARGET_ENV_VAR=$(echo "CARGO_TARGET_${{ matrix.target }}" | tr '[:lower:]-' '[:upper:]_')"_RUSTFLAGS"
          echo "Setting $TARGET_ENV_VAR=${{ matrix.env_rustflags }}"
          echo "$TARGET_ENV_VAR=${{ matrix.env_rustflags }}" >> $GITHUB_ENV
          
      - name: "5. Build Static Binary"
        id: build # ç»™è¿™ä¸ªæ­¥éª¤ä¸€ä¸ªidï¼Œä»¥ä¾¿åç»­å¼•ç”¨
        env:
          # ------------------------------------------------------------------
          # å¯æ‰§è¡Œæ–‡ä»¶å
          PROGRAM_NAME: "provisioner-daemon"
          # ------------------------------------------------------------------
        run: |
          # æ ¹æ® 'features' æ˜¯å¦ä¸ºç©ºï¼ŒåŠ¨æ€æ„å»ºå‘½ä»¤
          BUILD_COMMAND="cross build --target=${{ matrix.target }} --release"
          if [ -n "${{ matrix.features }}" ]; then
            BUILD_COMMAND="$BUILD_COMMAND --features \"${{ matrix.features }}\""
          fi

          echo "Running: $BUILD_COMMAND"
          eval $BUILD_COMMAND
          
          # --- å‡†å¤‡ä¸Šä¼ äº§ç‰© ---
          # 1. æ‰¾åˆ°æºæ–‡ä»¶è·¯å¾„
          SOURCE_PATH="target/${{ matrix.target }}/release/${PROGRAM_NAME}"
          
          # 2. å®šä¹‰æ¸…æ™°çš„ç›®æ ‡æ–‡ä»¶å (e.g., your-program-name-armv7-musleabihf)
          DEST_NAME="${PROGRAM_NAME}-${{ matrix.asset_suffix }}"
          
          echo "Moving '$SOURCE_PATH' to '$DEST_NAME'"
          mv $SOURCE_PATH $DEST_NAME
          
          # 3. å°†ç›®æ ‡æ–‡ä»¶åè¾“å‡ºï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "asset_path=$DEST_NAME" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        with:
            tag_name: ${{ github.ref_name }}
            release_name: Release ${{ github.ref_name }}
            draft: false
            prerelease: false

      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        with:
            upload_url: ${{ steps.create_release.outputs.upload_url }}
            asset_path: ${{ steps.build.outputs.asset_path }}
            asset_name: ${{ steps.build.outputs.asset_path }}
            asset_content_type: application/octet-stream